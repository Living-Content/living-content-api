# User ID System Documentation

## Overview

The system manages two distinct types of user identifiers:

1. Internal User ID (`user_id`): A UUID generated by the system
2. Auth Provider User ID (`X-Auth-User-ID`): An external identifier from authentication providers

## User ID Types

### Internal User ID

- Generated as a UUID v4 when a user is first created in the system
- Stored as `_id` in MongoDB user documents
- Used as the primary identifier for all internal operations
- Never changes once assigned
- Format: UUID v4 string (e.g., "550e8400-e29b-41d4-a716-446655440000")

### Auth Provider User ID

- External identifier supplied by authentication providers
- Passed in `X-Auth-User-ID` header
- Linked to the internal user_id through the `authProviders` field in user document
- Can have multiple auth provider IDs for the same internal user
- Format: Determined by the auth provider

## User Document Structure

```javascript
{
    "_id": "550e8400-e29b-41d4-a716-446655440000",  // Internal user_id
    "authProviders": {
        "creativePassport": "cp_12345",              // Auth provider user IDs
        "otherProvider": "op_67890"
    },
    "accessToken": "current-access-token",
    // ... other user fields
}
```

## ID Mapping Flow

1. New User via Auth Provider

   ```mermaid
   graph TD
       A[Auth Provider Login] -->|X-Auth-User-ID| B[Check Existing User]
       B -->|Not Found| C[Generate Internal user_id]
       C --> D[Create User Document]
       D --> E[Link Auth Provider ID]
       B -->|Found| F[Use Existing user_id]
   ```

2. **Direct API Access**

   ```mermaid
   graph TD
       A[API Request] -->|user_id + access_token| B[Validate Token]
       B -->|Valid| C[Process Request]
       B -->|Invalid| D[Return 401]
   ```

## Header Usage

### Auth Provider Requests

```http
X-Auth-Provider: creative_passport
X-Auth-User-ID: cp_12345
Authorization: Bearer provider_secret
```

### Direct API Requests

```http
X-User-ID: 550e8400-e29b-41d4-a716-446655440000
Authorization: Bearer user_access_token
```

## Important Notes

1. ID Translation
   - The system automatically handles translation between auth provider IDs and internal user_ids
   - All internal operations use the internal user_id exclusively
   - Auth providers only need to know their own user IDs

2. Multiple Auth Providers
   - A single internal user_id can be linked to multiple auth provider IDs
   - This enables single user account with multiple login methods
   - The `authProviders` field maintains these mappings

3. Access Control
   - Auth providers can only access users they created
   - Each auth provider request is validated against their provider secret
   - Direct API access requires the internal user_id and valid access token

## Example Flows

### User Creation via Auth Provider

```javascript
// 1. Incoming auth request
headers = {
    "X-Auth-Provider": "creative_passport",
    "X-Auth-User-ID": "cp_12345",
    "Authorization": "Bearer provider_secret"
}

// 2. Generated internal user document
{
    "_id": "550e8400-e29b-41d4-a716-446655440000",
    "authProviders": {
        "creativePassport": "cp_12345"
    },
    "accessToken": "new-access-token",
    "createdAt": "2024-11-14T00:00:00Z"
}

// 3. Response
{
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "accessToken": "new-access-token",
    "isNewUser": true
}
```

### Subsequent Auth

```javascript
// 1. Same auth request
headers = {
    "X-Auth-Provider": "creative_passport",
    "X-Auth-User-ID": "cp_12345",
    "Authorization": "Bearer provider_secret"
}

// 2. Response (existing user)
{
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "accessToken": "existing-access-token",
    "isNewUser": false
}
```

## Best Practices

1. Auth Providers Should:
   - Consistently use the same user ID format
   - Include both `X-Auth-Provider` and `X-Auth-User-ID` headers in all requests
   - Use their provider secret for authentication

2. Direct API Users Should:
   - Always use the internal user_id
   - Never expose auth provider IDs in their applications
   - Include both `X-User-ID` and access token in all requests

3. Security Considerations:
   - Never expose internal user_ids to end users
   - Validate all ID translations
   - Maintain separate access tokens for each auth method
